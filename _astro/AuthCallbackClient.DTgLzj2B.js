import{u as y,j as e}from"./useTranslations.3K2L2pz4.js";import{r as m}from"./index.BpawKBta.js";import{u as g}from"./useAuthStore.DRmIAJ9f.js";import{A}from"./TitleUpdater.CM5_3pk8.js";import{A as S,L as N}from"./Alert.qBavEDjr.js";import{B as p}from"./Button.C6c-rj7E.js";import{g as C}from"./auth.service.DX0mUkDK.js";const M=()=>{const[n,i]=m.useState("loading"),[k,w]=m.useState(null),{setUser:x,setLoading:c}=g(),t=y();m.useEffect(()=>{(async()=>{try{i("loading"),c(!0);const s=new URLSearchParams(window.location.search),a=s.get("access_token"),l=s.get("refresh_token"),v=s.get("user_id"),f=s.get("success"),o=s.get("error"),u=window.location.pathname.split("/").pop();if(console.log("OAuth callback parameters:",{accessToken:a?"present":"missing",refreshToken:l?"present":"missing",userId:v,success:f,error:o,provider:u}),o){let r="Erreur d'authentification OAuth";switch(o){case"oauth_error":r=`Erreur lors de l'authentification avec ${u}`;break;case"invalid_state":r="Session d'authentification invalide ou expirée";break;case"oauth_failed":r=`Impossible de récupérer les informations de ${u}`;break;default:r=`Erreur OAuth: ${o}`}throw new Error(r)}if(!a||!l||f!=="true")throw new Error("Authentification OAuth incomplète");localStorage.setItem("access_token",a),localStorage.setItem("refresh_token",l);const b=C(),d=await fetch(`${b}/api/auth/me`,{headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"}});if(!d.ok){const r=await d.json().catch(()=>({}));throw new Error(r.detail||"Impossible de récupérer les informations utilisateur")}const h=await d.json();console.log("User data received:",h),x(h),g.getState().setUser(h),g.setState({isAuthenticated:!0}),i("success"),window.history.replaceState({},document.title,window.location.pathname),setTimeout(()=>{const r=sessionStorage.getItem("oauth_return_url")||"/dashboard";sessionStorage.removeItem("oauth_return_url"),window.location.href=r==="/auth/login"||r==="/auth/register"?"/dashboard":r},1e3)}catch(s){console.error("OAuth callback error:",s),w(s instanceof Error?s.message:"Erreur d'authentification OAuth"),i("error")}finally{c(!1)}})()},[x,c]);const j=()=>{localStorage.removeItem("access_token"),localStorage.removeItem("refresh_token"),sessionStorage.removeItem("oauth_return_url"),window.location.href="/auth/login"},_=()=>{switch(n){case"loading":return e.jsxs("div",{className:"text-center space-y-6",children:[e.jsx(N,{size:"lg"}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-2",children:t.auth?.processing_login||"Traitement de la connexion..."}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:t.auth?.please_wait||"Veuillez patienter pendant que nous vous connectons."})]})]});case"success":return e.jsxs("div",{className:"text-center space-y-6",children:[e.jsx("div",{className:"mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 dark:bg-green-900/20",children:e.jsx("svg",{className:"h-6 w-6 text-green-600 dark:text-green-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-2",children:t.auth?.login_success||"Connexion réussie !"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:t.auth?.redirecting||"Redirection vers le tableau de bord..."})]})]});case"error":return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 dark:bg-red-900/20",children:e.jsx("svg",{className:"h-6 w-6 text-red-600 dark:text-red-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),e.jsx("h3",{className:"mt-4 text-lg font-semibold text-gray-900 dark:text-white",children:t.auth?.login_failed||"Échec de la connexion"})]}),e.jsx(S,{variant:"destructive",children:k||t.auth?.oauth_error||"Erreur lors de l'authentification OAuth"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(p,{onClick:j,className:"w-full",children:t.auth?.back_to_login||"Retour à la connexion"}),e.jsx(p,{variant:"outline",onClick:()=>window.location.href="/",className:"w-full",children:t.auth?.back_to_home||"Retour à l'accueil"})]})]});default:return null}};return e.jsx(A,{title:n==="success"?t.auth?.login_success||"Connexion réussie":n==="error"?t.auth?.login_failed||"Échec de la connexion":t.auth?.login_title||"Connexion en cours",children:_()})};export{M as A};
