import{b as d,G as w,P as f,a as i}from"./auth.service.8-EAQZcQ.js";import{u as g}from"./useAuthStore.DEd4f2p1.js";import{A as l}from"./auth.DWv5k-Tp.js";import"./index.BpawKBta.js";class o{static instance;authGuard;isInitialized=!1;constructor(){this.authGuard=l.getInstance()}static getInstance(){return o.instance||(o.instance=new o),o.instance}async initialize(){if(!this.isInitialized)try{await this.authGuard.initialize(),this.setupRouteProtection(),this.isInitialized=!0}catch(t){throw console.error("Route protection initialization failed:",t),t}}setupRouteProtection(){this.handleCurrentRoute(),window.addEventListener("popstate",()=>{this.handleCurrentRoute()}),document.addEventListener("click",t=>{const r=t.target.closest("a[href]");if(r&&this.isInternalLink(r.href)){const s=new URL(r.href).pathname;this.checkRouteAccess(s)}})}async handleCurrentRoute(){const t=window.location.pathname;await this.checkRouteAccess(t)}async checkRouteAccess(t){try{if(this.isProtectedRoute(t)&&!await this.authGuard.requireAuth())return;this.isGuestOnlyRoute(t)&&this.authGuard.isAuthenticated()&&this.redirectToDashboard()}catch(e){console.error("Route access check failed:",e),this.isProtectedRoute(t)&&this.redirectToLogin()}}isProtectedRoute(t){return d.some(e=>{if(e.endsWith("*")){const r=e.slice(0,-1);return t.startsWith(r)}return t===e})}isGuestOnlyRoute(t){return w.some(e=>{if(e.endsWith("*")){const r=e.slice(0,-1);return t.startsWith(r)}return t===e})}isPublicRoute(t){return f.some(e=>{if(e.endsWith("*")){const r=e.slice(0,-1);return t.startsWith(r)}return t===e})}isInternalLink(t){try{return new URL(t).origin===window.location.origin}catch{return!1}}redirectToLogin(){const t=window.location.pathname,e=this.isPublicRoute(t)?"":`?returnUrl=${encodeURIComponent(t)}`;window.location.href=`/auth/login${e}`}redirectToDashboard(){const e=new URLSearchParams(window.location.search).get("returnUrl");e&&!this.isGuestOnlyRoute(e)?window.location.href=e:window.location.href="/dashboard"}}const y=async()=>{try{await o.getInstance().initialize()}catch(a){console.error("Failed to initialize route protection:",a)}};class c{static instance;isInitialized=!1;authStore;constructor(){this.authStore=g.getState()}static getInstance(){return c.instance||(c.instance=new c),c.instance}async initialize(){if(!this.isInitialized)try{console.log("Initializing global authentication...");const t=i.getStoredUser();t&&this.authStore.setUser(t),i.isAuthenticated()&&await this.validateCurrentSession(),await y(),this.setupTokenRefreshInterceptor(),this.setupStorageListener(),this.isInitialized=!0,console.log("Global authentication initialized successfully")}catch(t){console.error("Failed to initialize global authentication:",t),await this.clearAuthData()}}async validateCurrentSession(){try{if(i.isTokenExpired())try{await i.refreshToken()}catch{console.warn("Token refresh failed, clearing auth data"),await this.clearAuthData();return}const t=await i.getCurrentUser();t?this.authStore.setUser(t):await this.clearAuthData()}catch(t){console.error("Session validation failed:",t),await this.clearAuthData()}}setupTokenRefreshInterceptor(){const t=window.fetch;window.fetch=async(e,r)=>{try{const s=await i.ensureValidToken();if(s&&r?.headers){const n=new Headers(r.headers);n.set("Authorization",`Bearer ${s}`),r.headers=n}const u=await t(e,r);if(u.status===401&&i.isAuthenticated())try{const n=await i.refreshToken();if(n&&r?.headers){const h=new Headers(r.headers);return h.set("Authorization",`Bearer ${n}`),r.headers=h,await t(e,r)}}catch{console.warn("Token refresh failed during request intercept"),await this.clearAuthData()}return u}catch(s){return console.error("Request interceptor error:",s),t(e,r)}}}setupStorageListener(){window.addEventListener("storage",t=>{t.key==="access_token"&&(t.newValue||(this.authStore.setUser(null),this.authStore.setLoading(!1)))})}async clearAuthData(){await i.logout(),this.authStore.setUser(null),this.authStore.setLoading(!1),this.authStore.clearError()}isAuthenticated(){return i.isAuthenticated()&&!i.isTokenExpired()}async logout(){await this.clearAuthData(),window.location.href="/auth/login"}getCurrentUser(){return this.authStore.user}}const A=async()=>{try{await c.getInstance().initialize()}catch(a){console.error("Failed to initialize global auth:",a)}};(async()=>{try{await A();const a=document.body.dataset.requireAuth==="true",t=document.body.dataset.requireGuest==="true",e=l.getInstance();if(a&&!await e.requireAuth())return;t&&e.requireGuest()}catch(a){console.error("Failed to initialize auth:",a),document.body.dataset.requireAuth==="true"&&(window.location.href="/auth/login")}})();
