import{u as y,j as e}from"./useTranslations.3K2L2pz4.js";import{r as h}from"./index.BpawKBta.js";import{u as A}from"./useAuthStore.DEd4f2p1.js";import{A as N}from"./TitleUpdater.B2nVOQO0.js";import{A as S,L as C}from"./Alert.qBavEDjr.js";import{B as m}from"./Button.C6c-rj7E.js";import{g as E}from"./auth.service.8-EAQZcQ.js";const M=()=>{const[n,i]=h.useState("loading"),[p,k]=h.useState(null),{setUser:x,setLoading:c}=A(),t=y();h.useEffect(()=>{(async()=>{try{i("loading"),c(!0);const r=new URLSearchParams(window.location.search),o=r.get("access_token"),l=r.get("refresh_token"),b=r.get("user_id"),g=r.get("success"),a=r.get("error"),u=window.location.pathname.split("/").pop();if(console.log("OAuth callback parameters:",{accessToken:o?"present":"missing",refreshToken:l?"present":"missing",userId:b,success:g,error:a,provider:u}),a){let s="Erreur d'authentification OAuth";switch(a){case"oauth_error":s=`Erreur lors de l'authentification avec ${u}`;break;case"invalid_state":s="Session d'authentification invalide ou expirée";break;case"oauth_failed":s=`Impossible de récupérer les informations de ${u}`;break;default:s=`Erreur OAuth: ${a}`}throw new Error(s)}if(!o||!l||g!=="true")throw new Error("Authentification OAuth incomplète");localStorage.setItem("access_token",o),localStorage.setItem("refresh_token",l);const v=E(),d=await fetch(`${v}/api/auth/me`,{headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"}});if(!d.ok){const s=await d.json().catch(()=>({}));throw new Error(s.detail||"Impossible de récupérer les informations utilisateur")}const f=await d.json();console.log("User data received:",f),x(f),i("success"),window.history.replaceState({},document.title,window.location.pathname),setTimeout(()=>{const s=sessionStorage.getItem("oauth_return_url")||"/dashboard";sessionStorage.removeItem("oauth_return_url"),window.location.href=s},1500)}catch(r){console.error("OAuth callback error:",r),k(r instanceof Error?r.message:"Erreur d'authentification OAuth"),i("error")}finally{c(!1)}})()},[x,c]);const w=()=>{localStorage.removeItem("access_token"),localStorage.removeItem("refresh_token"),sessionStorage.removeItem("oauth_return_url"),window.location.href="/auth/login"},j=()=>{window.location.href="/dashboard"},_=()=>{switch(n){case"loading":return e.jsxs("div",{className:"text-center space-y-6",children:[e.jsx(C,{size:"lg"}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-2",children:t.auth?.processing_login||"Traitement de la connexion..."}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:t.auth?.please_wait||"Veuillez patienter pendant que nous vous connectons."})]})]});case"success":return e.jsxs("div",{className:"text-center space-y-6",children:[e.jsx("div",{className:"mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 dark:bg-green-900/20",children:e.jsx("svg",{className:"h-6 w-6 text-green-600 dark:text-green-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-2",children:t.auth?.login_success||"Connexion réussie !"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:t.auth?.redirecting||"Redirection vers le tableau de bord..."})]}),e.jsx(m,{onClick:j,className:"w-full",children:t.auth?.go_to_dashboard||"Aller au tableau de bord"})]});case"error":return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 dark:bg-red-900/20",children:e.jsx("svg",{className:"h-6 w-6 text-red-600 dark:text-red-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),e.jsx("h3",{className:"mt-4 text-lg font-semibold text-gray-900 dark:text-white",children:t.auth?.login_failed||"Échec de la connexion"})]}),e.jsx(S,{variant:"destructive",children:p||t.auth?.oauth_error||"Erreur lors de l'authentification OAuth"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(m,{onClick:w,className:"w-full",children:t.auth?.back_to_login||"Retour à la connexion"}),e.jsx(m,{variant:"outline",onClick:()=>window.location.href="/",className:"w-full",children:t.auth?.back_to_home||"Retour à l'accueil"})]})]});default:return null}};return e.jsx(N,{title:n==="success"?t.auth?.login_success||"Connexion réussie":n==="error"?t.auth?.login_failed||"Échec de la connexion":t.auth?.login_title||"Connexion en cours",children:_()})};export{M as A};
