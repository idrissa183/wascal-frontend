import{u as N,j as e}from"./useTranslations.3K2L2pz4.js";import{r as g}from"./index.BpawKBta.js";import{u as x}from"./useAuthStore.DRmIAJ9f.js";import{A as C}from"./TitleUpdater.CM5_3pk8.js";import{A as E,L}from"./Alert.qBavEDjr.js";import{B as f}from"./Button.C6c-rj7E.js";import{g as I}from"./auth.service.DX0mUkDK.js";const q=()=>{const[n,i]=g.useState("loading"),[w,j]=g.useState(null),{setUser:p,setLoading:c}=x(),t=N();g.useEffect(()=>{(async()=>{try{i("loading"),c(!0);const r=new URLSearchParams(window.location.search),a=r.get("access_token"),l=r.get("refresh_token"),y=r.get("user_id"),k=r.get("success"),o=r.get("error"),u=window.location.pathname.split("/").pop();if(console.log("OAuth callback parameters:",{accessToken:a?"present":"missing",refreshToken:l?"present":"missing",userId:y,success:k,error:o,provider:u}),o){let s="Erreur d'authentification OAuth";switch(o){case"oauth_error":s=`Erreur lors de l'authentification avec ${u}`;break;case"invalid_state":s="Session d'authentification invalide ou expirée";break;case"oauth_failed":s=`Impossible de récupérer les informations de ${u}`;break;default:s=`Erreur OAuth: ${o}`}throw new Error(s)}if(!a||!l||k!=="true")throw new Error("Authentification OAuth incomplète");localStorage.setItem("access_token",a),localStorage.setItem("refresh_token",l);const A=I(),d=await fetch(`${A}/api/auth/me`,{headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"}});if(!d.ok){const s=await d.json().catch(()=>({}));throw new Error(s.detail||"Impossible de récupérer les informations utilisateur")}const h=await d.json();console.log("User data received:",h),p(h),x.getState().setUser(h),x.setState({isAuthenticated:!0}),i("success"),window.history.replaceState({},document.title,window.location.pathname),console.log("OAuth success - redirecting to dashboard automatically...");const m=sessionStorage.getItem("oauth_return_url")||"/dashboard";sessionStorage.removeItem("oauth_return_url");const S=m==="/auth/login"||m==="/auth/register"?"/dashboard":m;window.location.replace(S)}catch(r){console.error("OAuth callback error:",r),j(r instanceof Error?r.message:"Erreur d'authentification OAuth"),i("error")}finally{c(!1)}})()},[p,c]);const b=()=>{localStorage.removeItem("access_token"),localStorage.removeItem("refresh_token"),sessionStorage.removeItem("oauth_return_url"),window.location.href="/auth/login"},_=()=>{window.location.href="/dashboard"},v=()=>{switch(n){case"loading":return e.jsxs("div",{className:"text-center space-y-6",children:[e.jsx(L,{size:"lg"}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-2",children:t.auth?.processing_login||"Traitement de la connexion..."}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:t.auth?.please_wait||"Veuillez patienter pendant que nous vous connectons."}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 mt-2",children:"Redirection automatique vers le tableau de bord..."})]})]});case"success":return e.jsxs("div",{className:"text-center space-y-6",children:[e.jsx("div",{className:"mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 dark:bg-green-900/20",children:e.jsx("svg",{className:"h-6 w-6 text-green-600 dark:text-green-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-2",children:t.auth?.login_success||"Connexion réussie !"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:t.auth?.redirecting||"Redirection vers le tableau de bord..."})]}),e.jsx(f,{onClick:_,className:"w-full",children:t.auth?.go_to_dashboard||"Aller au tableau de bord"})]});case"error":return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 dark:bg-red-900/20",children:e.jsx("svg",{className:"h-6 w-6 text-red-600 dark:text-red-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),e.jsx("h3",{className:"mt-4 text-lg font-semibold text-gray-900 dark:text-white",children:t.auth?.login_failed||"Échec de la connexion"})]}),e.jsx(E,{variant:"destructive",children:w||t.auth?.oauth_error||"Erreur lors de l'authentification OAuth"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(f,{onClick:b,className:"w-full",children:t.auth?.back_to_login||"Retour à la connexion"}),e.jsx(f,{variant:"outline",onClick:()=>window.location.href="/",className:"w-full",children:t.auth?.back_to_home||"Retour à l'accueil"})]})]});default:return null}};return e.jsx(C,{title:n==="success"?t.auth?.login_success||"Connexion réussie":n==="error"?t.auth?.login_failed||"Échec de la connexion":t.auth?.login_title||"Connexion en cours",children:v()})};export{q as A};
